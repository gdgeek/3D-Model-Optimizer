<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
  <meta http-equiv="Content-Type" content="text/html; charset=utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>三维模型优化服务</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
  <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.min.css" rel="stylesheet">
  <script async src="https://unpkg.com/es-module-shims@1.8.0/dist/es-module-shims.js"></script>
  <script type="importmap">
  {
    "imports": {
      "three": "https://unpkg.com/three@0.160.0/build/three.module.js",
      "three/addons/": "https://unpkg.com/three@0.160.0/examples/jsm/"
    }
  }
  </script>
  <style>
    :root { --accent: #6f42c1; }
    * { box-sizing: border-box; margin: 0; padding: 0; }
    html, body { height: 100%; overflow: hidden; font-family: system-ui, -apple-system, sans-serif; background: #f8f9fa; }
    .app { display: flex; flex-direction: column; height: 100vh; }
    .main-content { display: flex; flex: 1; min-height: 0; }

    /* Sidebar */
    .sidebar { width: 350px; background: #fff; border-right: 1px solid #dee2e6; overflow-y: auto; flex-shrink: 0; }
    .sidebar::-webkit-scrollbar { width: 5px; }
    .sidebar::-webkit-scrollbar-thumb { background: #ced4da; border-radius: 3px; }
    .sidebar-section { padding: 16px; border-bottom: 1px solid #e9ecef; }
    .sidebar-section h6 { font-size: 0.8rem; font-weight: 600; color: #495057; margin-bottom: 12px; display: flex; align-items: center; gap: 6px; }

    /* Upload */
    .drop-zone { border: 2px dashed #ced4da; border-radius: 10px; padding: 28px 16px; text-align: center; cursor: pointer; transition: all 0.2s; background: #f8f9fa; }
    .drop-zone:hover, .drop-zone.dragover { border-color: var(--accent); background: rgba(111,66,193,0.04); }
    .drop-zone input { display: none; }

    /* Viewer area — use absolute positioning to guarantee height */
    .viewer-area { flex: 1; display: flex; flex-direction: column; min-width: 0; position: relative; overflow: hidden; }
    .viewer-toolbar { background: #fff; border-bottom: 1px solid #dee2e6; flex-shrink: 0; }
    .viewer-container { flex: 1 1 0%; display: flex; position: relative; overflow: hidden; }
    .viewer-panel { flex: 1 1 0%; position: relative; background: #e9ecef; overflow: hidden; }
    .viewer-label { position: absolute; top: 10px; left: 50%; transform: translateX(-50%); z-index: 10; pointer-events: none; }
    .viewer-divider { width: 3px; background: var(--accent); cursor: col-resize; z-index: 5; flex-shrink: 0; }
    .viewer-divider:hover { background: #7c4dff; }
    .viewer-info { position: absolute; bottom: 10px; left: 10px; z-index: 10; pointer-events: none; }
    .viewer-placeholder { display: flex; align-items: center; justify-content: center; height: 100%; color: #adb5bd; }

    /* Stats */
    .stat-card { background: #f8f9fa; border: 1px solid #e9ecef; border-radius: 8px; padding: 10px; text-align: center; }
    .stat-card .stat-value { font-size: 1.1rem; font-weight: 700; color: var(--accent); }
    .stat-card .stat-label { font-size: 0.7rem; color: #6c757d; }

    /* Steps */
    .step-item { display: flex; align-items: center; padding: 4px 0; font-size: 0.8rem; }
    .step-icon { width: 20px; height: 20px; border-radius: 50%; display: inline-flex; align-items: center; justify-content: center; margin-right: 8px; font-size: 0.65rem; flex-shrink: 0; }

    /* Info rows */
    .info-row { display: flex; justify-content: space-between; padding: 3px 0; font-size: 0.8rem; }
    .info-label { color: #6c757d; }
    .info-value { color: #212529; font-weight: 500; }

    /* Loading */
    .loading-box { display: none; padding: 20px; text-align: center; }
    .loading-box.show { display: block; }

    /* Auth */
    .auth-bar { display: none; background: #fff; border-bottom: 1px solid #dee2e6; }
    .auth-bar.show { display: flex; }

    .hidden { display: none !important; }
    .form-check-input:checked { background-color: var(--accent); border-color: var(--accent); }
  </style>
</head>
<body>
  <div class="app">
    <nav class="navbar bg-white border-bottom px-3 py-2">
      <span class="navbar-brand mb-0 d-flex align-items-center gap-2">
        <i class="bi bi-box" style="color:var(--accent);font-size:1.2rem;"></i>
        <span class="fw-semibold" style="font-size:0.95rem;">三维模型优化服务</span>
      </span>
      <div class="d-flex align-items-center gap-3">
        <a href="/api-docs" target="_blank" class="btn btn-sm btn-outline-secondary"><i class="bi bi-journal-code me-1"></i>API 文档</a>
      </div>
    </nav>

    <div class="auth-bar px-3 py-2 align-items-center gap-2" id="authBar">
      <i class="bi bi-lock-fill text-warning"></i>
      <input type="password" id="apiKeyInput" class="form-control form-control-sm" placeholder="输入 API Key" style="max-width:280px;">
      <button id="saveApiKey" class="btn btn-sm btn-primary">保存</button>
    </div>

    <div class="main-content">
      <div class="sidebar">
        <!-- Upload -->
        <div class="sidebar-section">
          <h6><i class="bi bi-cloud-arrow-up"></i> 上传模型</h6>
          <div class="drop-zone" id="uploadArea">
            <input type="file" id="fileInput" accept=".glb,.gltf,.obj,.stl,.fbx,.usdz,.dae,.step,.stp">
            <i class="bi bi-cloud-arrow-up-fill d-block mb-2" style="font-size:1.8rem;color:#adb5bd;"></i>
            <p class="text-secondary small mb-1">点击或拖拽文件到此处</p>
            <p class="text-muted mb-0" style="font-size:0.7rem;">GLB · GLTF · OBJ · STL · DAE · FBX · USDZ · STEP</p>
            <div class="mt-2 fw-medium small" style="color:var(--accent);" id="fileName"></div>
          </div>
          <div class="loading-box" id="analyzeLoading">
            <div class="spinner-border spinner-border-sm text-secondary" role="status"></div>
            <p class="text-secondary small mt-2 mb-0">分析模型中...</p>
          </div>
        </div>

        <!-- Model Info -->
        <div class="sidebar-section hidden" id="modelInfoSection">
          <h6><i class="bi bi-bar-chart-line"></i> 模型信息</h6>
          <div id="summaryBadges" class="mb-2"></div>
          <div id="basicInfo"></div>
          <div id="meshInfo" class="mt-1"></div>
        </div>

        <!-- Options -->
        <div class="sidebar-section hidden" id="optionsSection">
          <h6><i class="bi bi-sliders"></i> 优化选项</h6>
          <div class="form-check mb-1"><input class="form-check-input" type="checkbox" id="cleanEnabled" checked><label class="form-check-label small" for="cleanEnabled">资源清理</label></div>
          <div class="ps-4 mb-2">
            <div class="form-check"><input class="form-check-input" type="checkbox" id="removeUnusedNodes" checked><label class="form-check-label small text-muted" for="removeUnusedNodes">未使用节点</label></div>
            <div class="form-check"><input class="form-check-input" type="checkbox" id="removeUnusedMaterials" checked><label class="form-check-label small text-muted" for="removeUnusedMaterials">未使用材质</label></div>
            <div class="form-check"><input class="form-check-input" type="checkbox" id="removeUnusedTextures" checked><label class="form-check-label small text-muted" for="removeUnusedTextures">未使用纹理</label></div>
          </div>
          <div class="form-check mb-1"><input class="form-check-input" type="checkbox" id="mergeEnabled"><label class="form-check-label small" for="mergeEnabled">Mesh 合并</label></div>
          <div class="form-check mb-1"><input class="form-check-input" type="checkbox" id="simplifyEnabled"><label class="form-check-label small" for="simplifyEnabled">网格减面</label></div>
          <div class="d-flex align-items-center gap-2 ps-4 mb-1"><span class="text-muted small">比例</span><input type="number" class="form-control form-control-sm" id="targetRatio" value="0.5" min="0.1" max="1" step="0.1" style="width:70px;"></div>
          <div class="ps-4 mb-2"><div class="form-check"><input class="form-check-input" type="checkbox" id="lockBorder"><label class="form-check-label small text-muted" for="lockBorder">保留边界</label></div></div>
          <div class="form-check mb-1"><input class="form-check-input" type="checkbox" id="quantizeEnabled"><label class="form-check-label small" for="quantizeEnabled">顶点量化</label></div>
          <div class="form-check mb-1"><input class="form-check-input" type="checkbox" id="dracoEnabled"><label class="form-check-label small" for="dracoEnabled">Draco 压缩</label></div>
          <div class="d-flex align-items-center gap-2 ps-4 mb-1"><span class="text-muted small">级别</span><input type="number" class="form-control form-control-sm" id="compressionLevel" value="7" min="0" max="10" style="width:70px;"></div>
          <div class="small text-success ps-4 hidden" id="dracoHint"><i class="bi bi-check-circle me-1"></i>已使用 Draco</div>
          <div class="form-check mb-1 mt-2"><input class="form-check-input" type="checkbox" id="textureEnabled"><label class="form-check-label small" for="textureEnabled">纹理压缩</label></div>
          <div class="d-flex align-items-center gap-2 ps-4 mb-1"><span class="text-muted small">模式</span><select class="form-select form-select-sm" id="textureMode" style="width:100px;"><option value="ETC1S">ETC1S</option><option value="UASTC">UASTC</option></select></div>
          <div class="small text-success ps-4 hidden" id="ktx2Hint"><i class="bi bi-check-circle me-1"></i>已使用 KTX2</div>
          <div class="mt-3">
            <button class="btn btn-sm w-100 text-white" id="optimizeBtn" disabled style="background:var(--accent);border-color:var(--accent);"><i class="bi bi-lightning-charge me-1"></i>开始优化</button>
          </div>
          <div class="loading-box" id="loading">
            <div class="spinner-border spinner-border-sm text-secondary" role="status"></div>
            <p class="text-secondary small mt-2 mb-0">优化处理中...</p>
          </div>
        </div>

        <!-- Results -->
        <div class="sidebar-section hidden" id="resultSection">
          <h6><i class="bi bi-graph-up-arrow"></i> 优化结果</h6>
          <div class="row g-2 mb-2">
            <div class="col-6"><div class="stat-card"><div class="stat-value" id="originalSize">-</div><div class="stat-label">原始大小</div></div></div>
            <div class="col-6"><div class="stat-card"><div class="stat-value" id="optimizedSize">-</div><div class="stat-label">优化后</div></div></div>
            <div class="col-6"><div class="stat-card"><div class="stat-value" id="savedSize">-</div><div class="stat-label">节省</div></div></div>
            <div class="col-6"><div class="stat-card"><div class="stat-value" id="compressionRatio">-</div><div class="stat-label">压缩比</div></div></div>
          </div>
          <div id="stepsList"></div>
          <button class="btn btn-sm btn-success w-100 mt-2" id="downloadBtn"><i class="bi bi-download me-1"></i>下载优化文件</button>
        </div>

        <div class="alert alert-danger mx-3 mt-2 small hidden" id="errorMsg" role="alert"></div>
      </div>

      <!-- 3D Viewer -->
      <div class="viewer-area">
        <div class="viewer-toolbar d-flex align-items-center gap-2 px-3 py-2">
          <div class="btn-group btn-group-sm">
            <button class="btn btn-outline-secondary active" id="btnSplit"><i class="bi bi-layout-split me-1"></i>对比</button>
            <button class="btn btn-outline-secondary" id="btnOriginal">原始</button>
            <button class="btn btn-outline-secondary" id="btnOptimized">优化</button>
          </div>
          <div class="vr mx-1"></div>
          <button class="btn btn-sm btn-outline-secondary" id="btnWireframe"><i class="bi bi-grid-3x3 me-1"></i>线框</button>
          <button class="btn btn-sm btn-outline-secondary" id="btnResetCamera"><i class="bi bi-arrows-angle-expand me-1"></i>重置</button>
          <div class="vr mx-1"></div>
          <div class="form-check form-check-inline mb-0">
            <input class="form-check-input" type="checkbox" id="syncCameras" checked>
            <label class="form-check-label small text-muted" for="syncCameras">同步相机</label>
          </div>
        </div>
        <div class="viewer-container" id="viewerContainer">
          <div class="viewer-panel" id="viewerLeft">
            <div class="viewer-label"><span class="badge bg-dark bg-opacity-50 fw-normal">原始模型</span></div>
            <div class="viewer-placeholder" id="placeholderLeft"><i class="bi bi-box me-2"></i>上传模型文件开始预览</div>
            <div class="viewer-info"><span class="badge bg-dark bg-opacity-50 fw-normal small" id="infoLeft"></span></div>
          </div>
          <div class="viewer-divider" id="viewerDivider"></div>
          <div class="viewer-panel" id="viewerRight">
            <div class="viewer-label"><span class="badge bg-dark bg-opacity-50 fw-normal">优化后模型</span></div>
            <div class="viewer-placeholder" id="placeholderRight"><i class="bi bi-box me-2"></i>优化后显示</div>
            <div class="viewer-info"><span class="badge bg-dark bg-opacity-50 fw-normal small" id="infoRight"></span></div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
  <script type="module">
    import * as THREE from 'three';
    import { OrbitControls } from 'three/addons/controls/OrbitControls.js';
    import { GLTFLoader } from 'three/addons/loaders/GLTFLoader.js';
    import { DRACOLoader } from 'three/addons/loaders/DRACOLoader.js';
    import { OBJLoader } from 'three/addons/loaders/OBJLoader.js';
    import { STLLoader } from 'three/addons/loaders/STLLoader.js';
    import { USDZLoader } from 'three/addons/loaders/USDZLoader.js';

    let selectedFile = null, currentTaskId = null, modelAnalysis = null;
    let apiKey = localStorage.getItem('api_key') || '';
    let wireframeMode = false, viewMode = 'split';
    let leftScene, leftCamera, leftRenderer, leftControls, leftModel;
    let rightScene, rightCamera, rightRenderer, rightControls, rightModel;

    const uploadArea = document.getElementById('uploadArea');
    const fileInput = document.getElementById('fileInput');
    const fileName = document.getElementById('fileName');
    const optimizeBtn = document.getElementById('optimizeBtn');
    const loading = document.getElementById('loading');
    const analyzeLoading = document.getElementById('analyzeLoading');
    const resultSection = document.getElementById('resultSection');
    const errorMsg = document.getElementById('errorMsg');
    const downloadBtn = document.getElementById('downloadBtn');
    const modelInfoSection = document.getElementById('modelInfoSection');
    const optionsSection = document.getElementById('optionsSection');

    // Auth
    async function checkAuth() {
      try {
        const res = await fetch('/api/status/test-auth-check', { method: 'GET', headers: getAuthHeaders() });
        if (res.status === 401) { document.getElementById('authBar').classList.add('show'); document.getElementById('apiKeyInput').value = apiKey; }
      } catch (e) {}
    }
    checkAuth();
    document.getElementById('saveApiKey').addEventListener('click', () => {
      apiKey = document.getElementById('apiKeyInput').value;
      localStorage.setItem('api_key', apiKey);
      document.getElementById('authBar').classList.remove('show');
    });
    function getAuthHeaders() { return apiKey ? { 'x-api-key': apiKey } : {}; }

    // ===== Three.js =====
    function createScene(container) {
      const scene = new THREE.Scene();
      scene.background = new THREE.Color(0xe9ecef);
      scene.add(new THREE.AmbientLight(0xffffff, 0.7));
      const d1 = new THREE.DirectionalLight(0xffffff, 0.9); d1.position.set(5, 10, 7); scene.add(d1);
      const d2 = new THREE.DirectionalLight(0xffffff, 0.3); d2.position.set(-5, -5, -5); scene.add(d2);
      scene.add(new THREE.GridHelper(10, 20, 0xced4da, 0xdee2e6));
      const camera = new THREE.PerspectiveCamera(45, 1, 0.01, 1000);
      camera.position.set(3, 2, 3);
      const renderer = new THREE.WebGLRenderer({ antialias: true });
      renderer.setPixelRatio(Math.min(window.devicePixelRatio, 2));
      renderer.outputColorSpace = THREE.SRGBColorSpace;
      renderer.toneMapping = THREE.ACESFilmicToneMapping;
      renderer.toneMappingExposure = 1.0;
      renderer.domElement.style.display = 'block';
      renderer.domElement.style.width = '100%';
      renderer.domElement.style.height = '100%';
      container.appendChild(renderer.domElement);
      // Size to actual container
      const w = container.clientWidth || 400, h = container.clientHeight || 400;
      renderer.setSize(w, h, false);
      camera.aspect = w / h;
      camera.updateProjectionMatrix();
      const controls = new OrbitControls(camera, renderer.domElement);
      controls.enableDamping = true; controls.dampingFactor = 0.05;
      return { scene, camera, renderer, controls };
    }

    function initViewers() {
      const lp = document.getElementById('viewerLeft'), rp = document.getElementById('viewerRight');
      const l = createScene(lp); leftScene = l.scene; leftCamera = l.camera; leftRenderer = l.renderer; leftControls = l.controls;
      const r = createScene(rp); rightScene = r.scene; rightCamera = r.camera; rightRenderer = r.renderer; rightControls = r.controls;
      let syncing = false;
      leftControls.addEventListener('change', () => {
        if (syncing || !document.getElementById('syncCameras').checked) return;
        syncing = true;
        rightCamera.position.copy(leftCamera.position); rightCamera.rotation.copy(leftCamera.rotation); rightControls.target.copy(leftControls.target); rightControls.update();
        syncing = false;
      });
      rightControls.addEventListener('change', () => {
        if (syncing || !document.getElementById('syncCameras').checked) return;
        syncing = true;
        leftCamera.position.copy(rightCamera.position); leftCamera.rotation.copy(rightCamera.rotation); leftControls.target.copy(rightControls.target); leftControls.update();
        syncing = false;
      });
      // Use ResizeObserver for reliable sizing
      const ro = new ResizeObserver(() => onResize());
      ro.observe(lp);
      ro.observe(rp);
      // Delay first resize to let layout settle
      requestAnimationFrame(() => { onResize(); animate(); });
    }

    function animate() { requestAnimationFrame(animate); leftControls.update(); rightControls.update(); leftRenderer.render(leftScene, leftCamera); rightRenderer.render(rightScene, rightCamera); }

    function onResize() {
      const lp = document.getElementById('viewerLeft'), rp = document.getElementById('viewerRight');
      if (leftRenderer && lp.clientWidth > 0 && lp.clientHeight > 0) { leftCamera.aspect = lp.clientWidth / lp.clientHeight; leftCamera.updateProjectionMatrix(); leftRenderer.setSize(lp.clientWidth, lp.clientHeight, false); }
      if (rightRenderer && rp.clientWidth > 0 && rp.clientHeight > 0) { rightCamera.aspect = rp.clientWidth / rp.clientHeight; rightCamera.updateProjectionMatrix(); rightRenderer.setSize(rp.clientWidth, rp.clientHeight, false); }
    }
    window.addEventListener('resize', onResize);

    function loadModelFromFile(file, scene, side) {
      return new Promise((resolve, reject) => {
        const url = URL.createObjectURL(file);
        const ext = file.name.split('.').pop().toLowerCase();
        const onLoad = (obj) => {
          let model = obj.scene || obj;
          const box = new THREE.Box3().setFromObject(model);
          const center = box.getCenter(new THREE.Vector3());
          const size = box.getSize(new THREE.Vector3());
          const maxDim = Math.max(size.x, size.y, size.z);
          const scale = 3 / maxDim;
          model.scale.setScalar(scale);
          model.position.sub(center.multiplyScalar(scale));
          model.position.y -= (box.min.y * scale);
          scene.add(model);
          let tris = 0, verts = 0;
          model.traverse(child => { if (child.isMesh && child.geometry) { const g = child.geometry; tris += g.index ? g.index.count / 3 : (g.attributes.position?.count || 0) / 3; verts += g.attributes.position?.count || 0; } });
          document.getElementById(side === 'left' ? 'infoLeft' : 'infoRight').textContent = `△ ${Math.round(tris).toLocaleString()} | ⬡ ${Math.round(verts).toLocaleString()}`;
          URL.revokeObjectURL(url); resolve(model);
        };
        if (ext === 'glb' || ext === 'gltf') {
          const loader = new GLTFLoader(); const dl = new DRACOLoader(); dl.setDecoderPath('https://www.gstatic.com/draco/versioned/decoders/1.5.6/'); loader.setDRACOLoader(dl); loader.load(url, onLoad, undefined, reject);
        } else if (ext === 'obj') {
          new OBJLoader().load(url, (obj) => { obj.traverse(c => { if (c.isMesh) c.material = new THREE.MeshStandardMaterial({ color: 0x888888, roughness: 0.6, metalness: 0.2 }); }); onLoad(obj); }, undefined, reject);
        } else if (ext === 'stl') {
          new STLLoader().load(url, (geo) => { geo.computeVertexNormals(); const m = new THREE.Mesh(geo, new THREE.MeshStandardMaterial({ color: 0x888888, roughness: 0.6, metalness: 0.2 })); const g = new THREE.Group(); g.add(m); onLoad(g); }, undefined, reject);
        } else if (ext === 'usdz') {
          const reader = new FileReader();
          reader.onload = () => {
            try {
              const loader = new USDZLoader();
              const group = loader.parse(reader.result);
              group.traverse(c => { if (c.isMesh && !c.material) c.material = new THREE.MeshStandardMaterial({ color: 0x888888, roughness: 0.6, metalness: 0.2 }); });
              onLoad(group);
            } catch (e) { reject(e); }
          };
          reader.onerror = reject;
          reader.readAsArrayBuffer(file);
          URL.revokeObjectURL(url);
          return;
        } else { URL.revokeObjectURL(url); reject(new Error('Format not supported for preview')); }
      });
    }

    function loadModelFromUrl(url, scene, side) {
      return new Promise((resolve, reject) => {
        const loader = new GLTFLoader(); const dl = new DRACOLoader(); dl.setDecoderPath('https://www.gstatic.com/draco/versioned/decoders/1.5.6/'); loader.setDRACOLoader(dl);
        loader.load(url, (gltf) => {
          const model = gltf.scene;
          const box = new THREE.Box3().setFromObject(model); const center = box.getCenter(new THREE.Vector3()); const size = box.getSize(new THREE.Vector3());
          const maxDim = Math.max(size.x, size.y, size.z); const scale = 3 / maxDim;
          model.scale.setScalar(scale); model.position.sub(center.multiplyScalar(scale)); model.position.y -= (box.min.y * scale);
          scene.add(model);
          let tris = 0, verts = 0;
          model.traverse(child => { if (child.isMesh && child.geometry) { const g = child.geometry; tris += g.index ? g.index.count / 3 : (g.attributes.position?.count || 0) / 3; verts += g.attributes.position?.count || 0; } });
          document.getElementById(side === 'left' ? 'infoLeft' : 'infoRight').textContent = `△ ${Math.round(tris).toLocaleString()} | ⬡ ${Math.round(verts).toLocaleString()}`;
          resolve(model);
        }, undefined, reject);
      });
    }

    function clearModel(scene, model) {
      if (model) { scene.remove(model); model.traverse(c => { if (c.geometry) c.geometry.dispose(); if (c.material) { if (Array.isArray(c.material)) c.material.forEach(m => m.dispose()); else c.material.dispose(); } }); }
      return null;
    }
    function fitCamera(camera, controls, model) {
      if (!model) return;
      const box = new THREE.Box3().setFromObject(model); const center = box.getCenter(new THREE.Vector3()); const size = box.getSize(new THREE.Vector3());
      const dist = Math.max(size.x, size.y, size.z) * 1.5;
      camera.position.set(center.x + dist, center.y + dist * 0.6, center.z + dist); controls.target.copy(center); controls.update();
    }
    function toggleWireframe(model, enabled) {
      if (!model) return;
      model.traverse(c => { if (c.isMesh && c.material) { (Array.isArray(c.material) ? c.material : [c.material]).forEach(m => { m.wireframe = enabled; }); } });
    }

    // ===== Toolbar =====
    document.getElementById('btnSplit').addEventListener('click', () => setViewMode('split'));
    document.getElementById('btnOriginal').addEventListener('click', () => setViewMode('original'));
    document.getElementById('btnOptimized').addEventListener('click', () => setViewMode('optimized'));
    function setViewMode(mode) {
      viewMode = mode;
      const left = document.getElementById('viewerLeft'), right = document.getElementById('viewerRight'), divider = document.getElementById('viewerDivider');
      document.querySelectorAll('.btn-group .btn').forEach(b => b.classList.remove('active'));
      if (mode === 'split') { left.style.display = ''; right.style.display = ''; divider.style.display = ''; document.getElementById('btnSplit').classList.add('active'); }
      else if (mode === 'original') { left.style.display = ''; right.style.display = 'none'; divider.style.display = 'none'; document.getElementById('btnOriginal').classList.add('active'); }
      else { left.style.display = 'none'; right.style.display = ''; divider.style.display = 'none'; document.getElementById('btnOptimized').classList.add('active'); }
      setTimeout(onResize, 50);
    }
    document.getElementById('btnWireframe').addEventListener('click', function() { wireframeMode = !wireframeMode; this.classList.toggle('active', wireframeMode); toggleWireframe(leftModel, wireframeMode); toggleWireframe(rightModel, wireframeMode); });
    document.getElementById('btnResetCamera').addEventListener('click', () => { if (leftModel) fitCamera(leftCamera, leftControls, leftModel); if (rightModel) fitCamera(rightCamera, rightControls, rightModel); });

    // ===== Upload =====
    uploadArea.addEventListener('click', () => fileInput.click());
    uploadArea.addEventListener('dragover', (e) => { e.preventDefault(); uploadArea.classList.add('dragover'); });
    uploadArea.addEventListener('dragleave', () => uploadArea.classList.remove('dragover'));
    uploadArea.addEventListener('drop', (e) => { e.preventDefault(); uploadArea.classList.remove('dragover'); if (e.dataTransfer.files[0]) handleFile(e.dataTransfer.files[0]); });
    fileInput.addEventListener('change', (e) => { if (e.target.files[0]) handleFile(e.target.files[0]); });

    async function handleFile(file) {
      const ext = file.name.split('.').pop().toLowerCase();
      if (!['glb','gltf','obj','stl','fbx','usdz','dae','step','stp'].includes(ext)) { alert('不支持的文件格式'); return; }
      if (file.size > 100 * 1024 * 1024) { alert('文件超过 100MB'); return; }
      selectedFile = file;
      fileName.textContent = `${file.name} (${formatSize(file.size)})`;
      modelInfoSection.classList.add('hidden'); optionsSection.classList.add('hidden'); resultSection.classList.add('hidden'); errorMsg.classList.add('hidden'); optimizeBtn.disabled = true;
      leftModel = clearModel(leftScene, leftModel); document.getElementById('placeholderLeft').style.display = 'none'; document.getElementById('infoLeft').textContent = '';
      const clientPreviewFormats = ['glb', 'gltf', 'obj', 'stl', 'usdz'];
      if (clientPreviewFormats.includes(ext)) {
        try { leftModel = await loadModelFromFile(file, leftScene, 'left'); fitCamera(leftCamera, leftControls, leftModel); if (wireframeMode) toggleWireframe(leftModel, true); } catch (e) { console.warn('Preview not available:', e); }
      } else {
        document.getElementById('placeholderLeft').style.display = 'flex';
        document.getElementById('placeholderLeft').innerHTML = '<span class="text-muted"><i class="bi bi-eye-slash me-2"></i>' + ext.toUpperCase() + ' 格式不支持客户端预览，优化后可查看 GLB</span>';
      }
      rightModel = clearModel(rightScene, rightModel); document.getElementById('placeholderRight').style.display = 'flex'; document.getElementById('infoRight').textContent = '';
      await analyzeFile(file);
    }

    async function analyzeFile(file) {
      analyzeLoading.classList.add('show');
      const fd = new FormData(); fd.append('file', file);
      try {
        const res = await fetch('/api/analyze', { method: 'POST', body: fd, headers: getAuthHeaders() });
        const data = await res.json();
        if (data.success) { modelAnalysis = data.analysis; displayModelInfo(data.analysis); modelInfoSection.classList.remove('hidden'); optionsSection.classList.remove('hidden'); optimizeBtn.disabled = false; updateHints(data.analysis); }
        else showError(`分析失败: ${data.error?.message || '未知错误'}`);
      } catch (err) { showError(`分析请求失败: ${err.message}`); }
      finally { analyzeLoading.classList.remove('show'); }
    }

    function displayModelInfo(a) {
      document.getElementById('summaryBadges').innerHTML = `<span class="badge ${a.hasDraco ? 'text-bg-success' : 'text-bg-warning'} me-1">${a.hasDraco ? '✓ Draco' : '✗ Draco'}</span><span class="badge ${a.hasKTX2 ? 'text-bg-info' : 'text-bg-danger'}">${a.hasKTX2 ? '✓ KTX2' : '✗ KTX2'}</span>`;
      document.getElementById('basicInfo').innerHTML = `<div class="info-row"><span class="info-label">大小</span><span class="info-value">${formatSize(a.fileSize)}</span></div><div class="info-row"><span class="info-label">格式</span><span class="info-value">${a.format}</span></div><div class="info-row"><span class="info-label">节点</span><span class="info-value">${a.nodes}</span></div><div class="info-row"><span class="info-label">纹理</span><span class="info-value">${a.textures.count} (${formatSize(a.textures.totalSize)})</span></div>`;
      document.getElementById('meshInfo').innerHTML = `<div class="info-row"><span class="info-label">网格</span><span class="info-value">${a.meshes.count}</span></div><div class="info-row"><span class="info-label">三角形</span><span class="info-value">${a.meshes.totalTriangles.toLocaleString()}</span></div><div class="info-row"><span class="info-label">顶点</span><span class="info-value">${a.meshes.totalVertices.toLocaleString()}</span></div>`;
    }
    function updateHints(a) {
      if (a.hasDraco) { document.getElementById('dracoHint').classList.remove('hidden'); document.getElementById('dracoEnabled').checked = false; } else document.getElementById('dracoHint').classList.add('hidden');
      if (a.hasKTX2) { document.getElementById('ktx2Hint').classList.remove('hidden'); document.getElementById('textureEnabled').checked = false; } else document.getElementById('ktx2Hint').classList.add('hidden');
    }

    // ===== Optimize =====
    optimizeBtn.addEventListener('click', async () => {
      if (!selectedFile) return;
      loading.classList.add('show'); resultSection.classList.add('hidden'); errorMsg.classList.add('hidden'); optimizeBtn.disabled = true;
      const fd = new FormData(); fd.append('file', selectedFile); fd.append('options', JSON.stringify(getOptions()));
      try {
        const res = await fetch('/api/optimize', { method: 'POST', body: fd, headers: getAuthHeaders() });
        const data = await res.json();
        if (data.success) {
          currentTaskId = data.taskId; displayResult(data); resultSection.classList.remove('hidden');
          rightModel = clearModel(rightScene, rightModel); document.getElementById('placeholderRight').style.display = 'none';
          const dlUrl = apiKey ? `/api/download/${data.taskId}?api_key=${encodeURIComponent(apiKey)}` : `/api/download/${data.taskId}`;
          try {
            rightModel = await loadModelFromUrl(dlUrl, rightScene, 'right'); fitCamera(rightCamera, rightControls, rightModel);
            if (wireframeMode) toggleWireframe(rightModel, true);
            if (document.getElementById('syncCameras').checked && leftModel) { rightCamera.position.copy(leftCamera.position); rightCamera.rotation.copy(leftCamera.rotation); rightControls.target.copy(leftControls.target); rightControls.update(); }
          } catch (e) { console.warn('Could not load optimized preview:', e); document.getElementById('placeholderRight').style.display = 'flex'; document.getElementById('placeholderRight').textContent = '预览不可用'; }
        } else showError(`优化失败: ${data.error?.message || '未知错误'}`);
      } catch (err) { showError(`请求失败: ${err.message}`); }
      finally { loading.classList.remove('show'); optimizeBtn.disabled = false; }
    });

    function displayResult(data) {
      const orig = data.originalSize, opt = data.optimizedSize, saved = orig - opt;
      document.getElementById('originalSize').textContent = formatSize(orig);
      document.getElementById('optimizedSize').textContent = formatSize(opt);
      document.getElementById('savedSize').textContent = (saved >= 0 ? '-' : '+') + formatSize(Math.abs(saved));
      document.getElementById('compressionRatio').textContent = (data.compressionRatio * 100).toFixed(1) + '%';
      let html = '';
      if (data.conversion?.converted) html += `<div class="step-item"><span class="step-icon bg-success-subtle text-success">✓</span><span class="flex-grow-1">格式转换 (${data.conversion.originalFormat} → GLB)</span><span class="text-muted small">${data.conversion.conversionTime}ms</span></div>`;
      html += (data.steps || []).map(s => `<div class="step-item"><span class="step-icon ${s.success ? 'bg-success-subtle text-success' : 'bg-danger-subtle text-danger'}">${s.success ? '✓' : '✗'}</span><span class="flex-grow-1">${s.step}</span><span class="text-muted small">${s.duration}ms</span></div>`).join('');
      document.getElementById('stepsList').innerHTML = html;
    }

    downloadBtn.addEventListener('click', () => { if (currentTaskId) { window.location.href = apiKey ? `/api/download/${currentTaskId}?api_key=${encodeURIComponent(apiKey)}` : `/api/download/${currentTaskId}`; } });

    function formatSize(bytes) { if (!bytes) return '0 B'; if (bytes < 1024) return bytes + ' B'; if (bytes < 1024 * 1024) return (bytes / 1024).toFixed(1) + ' KB'; return (bytes / (1024 * 1024)).toFixed(2) + ' MB'; }
    function getOptions() {
      const o = {};
      if (document.getElementById('cleanEnabled').checked) o.clean = { enabled: true, removeUnusedNodes: document.getElementById('removeUnusedNodes').checked, removeUnusedMaterials: document.getElementById('removeUnusedMaterials').checked, removeUnusedTextures: document.getElementById('removeUnusedTextures').checked };
      if (document.getElementById('mergeEnabled').checked) o.merge = { enabled: true };
      if (document.getElementById('simplifyEnabled').checked) o.simplify = { enabled: true, targetRatio: parseFloat(document.getElementById('targetRatio').value), lockBorder: document.getElementById('lockBorder').checked };
      if (document.getElementById('quantizeEnabled').checked) o.quantize = { enabled: true };
      if (document.getElementById('dracoEnabled').checked) o.draco = { enabled: true, compressionLevel: parseInt(document.getElementById('compressionLevel').value) };
      if (document.getElementById('textureEnabled').checked) o.texture = { enabled: true, mode: document.getElementById('textureMode').value };
      return o;
    }
    function showError(msg) { errorMsg.textContent = msg; errorMsg.classList.remove('hidden'); }

    initViewers();
    onResize();
  </script>
</body>
</html>
